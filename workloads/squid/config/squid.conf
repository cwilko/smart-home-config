#pid_filename /run/squid.pid

workers 1
cpu_affinity_map process_numbers=1 cores=1

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Recommended default for manager:
acl manager proto cache_object

## Local network ACLs
acl localnet src 192.168.0.0/16
# For testing purposes - docker
acl dockernet src 172.17.0.0/16
# Kubernetes pod network
acl k8snet src 10.244.0.0/16

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
# Allow cache manager access from localnet
http_access allow manager localnet


http_access deny manager

# This default configuration only allows localhost requests because a more
# permissive Squid installation could introduce new attack vectors into the
# network by proxying external TCP connections to unprotected services.
http_access allow localhost

# The two deny rules below are unnecessary in this default configuration
# because they are followed by a "deny all" rule. However, they may become
# critically important when you start allowing external requests below them.

# Protect web applications running on the same server as Squid. They often
# assume that only local users can access them at "localhost" ports.
#http_access deny to_localhost

# Protect cloud servers that provide local users with sensitive info about
# their server via certain well-known link-local (a.k.a. APIPA) addresses.
#http_access deny to_linklocal

# Local access rules
http_access allow localnet
http_access allow dockernet
http_access allow k8snet

# Cache ACLs - allow caching of successful responses
acl success_status http_status 200 206 301 302 304
acl real_debrid dstdomain .download.real-debrid.com

# Cache directives
#cache allow real_debrid success_status
#cache allow success_status
#cache deny all

http_access deny all

maximum_object_size 200 GB
maximum_object_size_in_memory 5 MB
minimum_object_size 1 KB               # Cache objects larger than 1KB

# Stop Squid from being "chatty" with the kernel
#read_ahead_gap 64 MB
range_offset_limit 50 MB

# Increase the socket buffers to reduce context switching
tcp_recv_bufsize 1 MB

collapsed_forwarding on
#quick_abort_min -1 KB
#quick_abort_max -1 KB
range_forward_on_cache_miss on
#quick_abort_pct 100

# Deny ranges starting beyond 10GB  
#acl range_beyond_10gb req_header Range -i bytes=[1-9][0-9]{10,}-
#acl range_beyond_200b req_header Range -i bytes=200-

#cache deny range_beyond_10gb
#cache allow all
#cache deny all

#collapsed_forwarding_access deny range_beyond_10gb
#collapsed_forwarding_access allow all

# Store ID program for cache key normalization
# Required for dynamic urls from RD

store_id_program /usr/local/scripts/squid_store_id.py
store_id_children 5 startup=1 idle=1
store_id_access allow all

#http_port 3128 ssl-bump \
#    cert=/etc/squid/ssl_cert/myCA.pem \
#    generate-host-certificates=on \
#    dynamic_cert_mem_cache_size=4MB \
#    options=NO_SSLv3,NO_TLSv1 \
#    cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS  # NEW: More flexible cipher selection

http_port 3128 ssl-bump \
    cert=/etc/squid/ssl_cert/myCA.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=32MB \
    options=NO_SSLv3,NO_TLSv1,NO_TLSv1_1,SINGLE_ECDH_USE,CIPHER_SERVER_PREFERENCE \
    cipher=ECDHE-RSA-AES128-GCM-SHA256:AES128-GCM-SHA256

# Custom log format with content length
# Standard squid format but with human-readable timestamp
logformat custom %{%Y-%m-%d %H:%M:%S}tl %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
#logformat detailed %tl %6tr %>a %Ss/%03>Hs %<st %rm  %ru %[un %Sh/%<a %mt Content-Length:%>h{Content-Length} Range:%>h{Range}

# Use both default and detailed logging
access_log /var/log/squid/access.log custom
# Also log to stdout for kubectl logs (via symlink created by entrypoint)
access_log /var/log/squid/stdout.log custom
#access_log /var/log/squid/access-detailed.log detailed

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# SSL certificate generation program (Ubuntu path)
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

ssl_bump server-first all
sslproxy_cert_error allow all          # NEW: Ignores ALL SSL certificate errors


acl all src all
http_access allow all

# Real-Debrid API: 5 min to 24 hours
# Override all cache-prevention headers for Real-Debrid
refresh_pattern ^https://.*\.download\.real-debrid\.com/ 43200 95% 259200 override-expire ignore-private ignore-no-store override-lastmod ignore-reload reload-into-ims

# Also override by content type
refresh_pattern . 43200 95% 259200

cache_dir aufs /var/spool/squid 250000 16 256


#debug_options ALL,1 84,9
#debug_options 73,3
#debug_options ALL,1 88,9 11,5 90,3 20,3 85,5
# More comprehensive cache debugging
#debug_options ALL,1 11,9 58,9 20,9 32,9 86,9 85,9 88,9 90,3
pinger_enable off
